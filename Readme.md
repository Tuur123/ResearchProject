# Can we use a drone to scan CovidSafe QR Codes?

This research is divided up in these subcategories:

- Wich requirements does the drone need to meet inorder to do this? (camera’s, sensors...)
- Wich computer vision technique performs bests in person identification and tracking?
- How can the drone know wich people are already scanned?
- How secure does this system needs to be? Are there laws wich should be taken in consideration?
- In what way do I make the drone track people? Write my own code? Use a PID loop?
- Can I use a pathfinding algorithm to calculate optimal routes?
- Can the drone land automaticly by its charging station?
- When the drone scans an infected person, how does the system communicates this?

<br>

The research will be deemed a succes if these criteria are met:
 
1. DJI Tello quadcopter ✔️
2. Python software ✔️
3. System must be able to start and operate on its own. No manual interaction should be necessary. ✔️
4. Person classification should have more than 90% accuracy. ✔️
5. De tracking mean error should be lower than 200 pixels. ✔️ (Depends on lighting conditions)
6. Facial recognition software has to be fast enough -> drone should not be stationary by 1 person for more than 10 seconds.
7. There has to be an emergency stop implemented in the system. ✔️
8. Has to follow GDPR.

<br>

The drone I used to do this project is a DJI Tello. Its a small drone weighing only 80 grams. Its small enough so accidental bumbs and crashes dont hurt people and wont damage property.
There are some important technical aspects to consider when choosing a drone for this application:

1. Camera
2. Connection type
3. Height sensor

The camera has to be of good enough quality so the code can easily resolve faces and qr codes. The connection between the drone and the ground has to be stable enough so no controlling commands are lost wich can cause crashes or unwanted behaviour. The connection also needs to be able to handle a stream of HD video. WiFi would not be the best solution for this. Many times a frame would be dropped and the stream would hang causing unwanted behaviour. A better way would be to use the DJI Digital FPV system. The Tello drone offers a height sensor. This is crucial to keep the drone from crashing during operation. In the code we can query and regulate its height.

The mediapipe library offered the most of all the tested tracking methods. It had the hightest fps. The haarcascades tracker was often times unreliable and unusable.
Movenet had a big advantage because it runs on a gpu wich should made it faster. In practice it was never noticed as the maximum fps that can be achieved is 30, wich is the maximum the Tello's videostream can be set to. Therefore it was easier to use the mediapipe method as it also has a nicer api and doesnt need the numpy package.

To keep already scanned persons from being tracked by the drone I wanted to use face recognition. This would be legal because it would be in the interest of public health, according to the GDPR laws *Biometric data, including that generated by facial recognition software, is considered a special category of personal data under the GDPR since it makes it possible to uniquely identify a person. The 2018 privacy law prohibits the processing of such data unless there is explicit consent, a legal obligation or public interest.*

To make the drone fly after person it tracks, I opted to use PID loops instead of writing my own code because PID's are a proven concept. They are however hard to finetune and I still observe some overshooting and oscillations in the drones flying. It would be theoretically possible to create a pathfinding algorithm or use an existing one. But this would require additional cameras to monitor the movement of people in an area.

The Tello I used is not capable of returning to its home or takeof point. There is the Tello EDU variant wich has those capabilities. You could also track the movement of the drone and backtrack to its origin but that would have been very time consuming. 

When the drone scans an infected person, a secondary window will pop-up containing a close up of the face of this person.

<br>

## Setup

For this project you will need a windows machine as well as an Ubuntu VM. Both should have at least python 3.6 installed.
The VM will need to communicate with the windows machine through TCP. You can follow [this tutorial](https://youtu.be/kc-t2D7QaUM) for this.

Run this command on a windows machine to setup a virtual environment and install the required python modules.

>Powershell.exe -executionpolicy remotesigned -File  .\init.ps1

<br>

Run these commands on Ubuntu.
>sudo chmod +x init

>sudo ./init

<br>

## Use Guide

Once you've run the install scripts, start the server on the ubuntu VM first.
Then you can start the drone and connect your windows to the drones WiFi.

>![wifi image](https://raw.githubusercontent.com/Tuur123/ResearchProject/main/docs/wifi.png)

Then you can start the python script on the windows machine. The drone will take off after 2 seconds if you enable flying at line 10

>![flying enable](https://raw.githubusercontent.com/Tuur123/ResearchProject/main/docs/flying_enable.png)

You will see a livestream from the drones camera with some information on it such as a fps counter, battery percentage and what the drone is doing.
If a person is being tracked it will also draw some indicator lines on the persons face and the target of the drone.

>![stream](https://raw.githubusercontent.com/Tuur123/ResearchProject/main/docs/stream.png)

When the drone scans a QR Code you will see a secondary screen pop-up wich contains the face of the person and text wich tells you if the person scanned is SAFE or UNSAFE.

>![scanned person](https://raw.githubusercontent.com/Tuur123/ResearchProject/main/docs/scanned.png)

<br>

## Observations during research

Placing computer vision functions in threads improves fps drasticly (as much as 50x), 
however this increases the delay to a point where the PID control is rendered useless.

When flying over uneven ground drone will keep it highest altitude, e.g going higher to clear obstacle but not come down after.

When connecting to tello on device with more than 2 network adapters, windows will route those packets to the ethernet connection rather than wifi wich is connected to the tello.
This is fixed by modifying the djitellopy library. This is not possible on linux, where the kernel has absolute control over the routing and routing cant be changed.

>![bind socket image](https://raw.githubusercontent.com/Tuur123/ResearchProject/main/docs/bind_socket.png)

Posetracking with movenet doesnt give as much accuracy as with mediapipe.

PID's are hard to implement because of the latency, the drone always overshoot its target and they are really hard to finetune.

Scanning the CovidSafe QR Code give an encoded string wich cant be read, also the camera resolution of the drone used in this demo is not great, so scanning the complex offical codes is not feasible. That's why in this demo I supplied dummy codes (see QR folder).

If someone uses a phone of someone else, this can be detected because there will be 2 faces with the same qr code.

Because the python face_recognition softawere uses dlib, I use a ubuntu VM to run all recognition code in. Installing dlib on windows should be possible but I never made it work.
If you're having issues with the server connection when using a VM, perhaps [my short tutorial](https://youtu.be/kc-t2D7QaUM) will help you.

<br>

## If you want to replicate this kind of project, have a look at these comminities for usefull tips and information
>https://www.reddit.com/r/pythontips/

>https://forum.opencv.org/

>https://groups.google.com/g/mediapipe

<br>

## SOURCES

Covidsafe. “Bewijs dat je Covid Safe bent.” Accessed January 21, 2022. https://covidsafe.be/nl/.
Chaiyadecha, Sasiwut. “How to Install Dlib Library for Python in Windows 10.” Analytics Vidhya (blog), July 25, 2020. https://medium.com/analytics-vidhya/how-to-install-dlib-library-for-python-in-windows-10-57348ba1117f.
“Dlib C++ Library.” Accessed January 31, 2022. http://dlib.net/.
Geitgey, Adam. “Machine Learning Is Fun! Part 4: Modern Face Recognition with Deep Learning.” Medium (blog), September 24, 2020. https://medium.com/@ageitgey/machine-learning-is-fun-part-4-modern-face-recognition-with-deep-learning-c3cffc121d78.
“How to Detect QRCode and BarCode using OpenCV in Python + Project - YouTube.” Accessed January 25, 2022. https://www.youtube.com/.
LexisNexis. “Facial Recognition Probed across Europe under GDPR Ahead of New AI Rules.” Accessed February 1, 2022. https://mlexmarketinsight.com/news-hub/editors-picks/area-of-expertise/data-privacy-and-security/facial-recognition-probed-across-europe-under-gdpr-ahead-of-new-ai-rules.
“MediaPipe.” Accessed January 25, 2022. https://mediapipe.dev/.
Engineering Education (EngEd) Program | Section. “Multi-Person Pose Estimation with Python.” Accessed January 20, 2022. https://www.section.io/engineering-education/multi-person-pose-estimator-with-python/.
Palo, Norman Di. “How to Add Person Tracking to a Drone Using Deep Learning and NanoNets.” NanoNets (blog), July 13, 2018. https://medium.com/nanonets/how-i-built-a-self-flying-drone-to-track-people-in-under-50-lines-of-code-7485de7f828e.
Sandler, Mark, Andrew Howard, Menglong Zhu, Andrey Zhmoginov, and Liang-Chieh Chen. “MobileNetV2: Inverted Residuals and Linear Bottlenecks.” ArXiv:1801.04381 [Cs], March 21, 2019. http://arxiv.org/abs/1801.04381.


I particularly used https://mediapipe.dev/ very much, as the drone being able to accurately track persons is the largests cornerstone of this project.